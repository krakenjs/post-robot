!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define("postRobot",[],r):"object"==typeof exports?exports.postRobot=r():e.postRobot=r()}("undefined"!=typeof self?self:this,function(){return function(e){var r={};function n(t){if(r[t])return r[t].exports;var o=r[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=r,n.d=function(e,r,t){n.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:t})},n.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(r,"a",r),r},n.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},n.p="",n(n.s=1)}([function(e,r,n){"use strict";var t=n(2);n.d(r,"getActualDomain",function(){return t.a}),n.d(r,"getAncestor",function(){return t.b}),n.d(r,"getDomain",function(){return t.c}),n.d(r,"getUserAgent",function(){return t.d}),n.d(r,"isActuallySameDomain",function(){return t.e}),n.d(r,"isAncestor",function(){return t.f}),n.d(r,"isIframe",function(){return t.g}),n.d(r,"isPopup",function(){return t.h}),n.d(r,"isWindow",function(){return t.i}),n.d(r,"isWindowClosed",function(){return t.j}),n.d(r,"matchDomain",function(){return t.k}),n.d(r,"stringifyDomainPattern",function(){return t.l});var o=n(3);n.n(o)},function(e,r,n){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),n.d({},"WeakMap",function(){return u});var t={};n.d(t,"cleanUpWindow",function(){return ne}),n.d(t,"Promise",function(){return S}),n.d(t,"bridge",function(){return te}),n.d(t,"init",function(){return oe}),n.d(t,"parent",function(){return re}),n.d(t,"send",function(){return J}),n.d(t,"request",function(){return F}),n.d(t,"sendToParent",function(){return K}),n.d(t,"client",function(){return Z}),n.d(t,"on",function(){return X}),n.d(t,"listen",function(){return Q}),n.d(t,"once",function(){return V}),n.d(t,"listener",function(){return $}),n.d(t,"CONFIG",function(){return l}),n.d(t,"CONSTANTS",function(){return f}),n.d(t,"disable",function(){return ee});var o=n(0);function i(e,r){for(var n=0;n<e.length;n++)try{if(e[n]===r)return n}catch(e){}return-1}var a,s=Object.defineProperty,c=Date.now()%1e9,u=function(){function e(){if(function(r,n){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}(this),c+=1,this.name="__weakmap_"+(1e9*Math.random()>>>0)+"__"+c,function(){if(!window.WeakMap)return!1;if(!window.Object.freeze)return!1;try{var e=new window.WeakMap,r={};return window.Object.freeze(r),e.set(r,"__testvalue__"),"__testvalue__"===e.get(r)}catch(e){return!1}}())try{this.weakmap=new window.WeakMap}catch(e){}this.keys=[],this.values=[]}return e.prototype._cleanupClosedWindows=function(){for(var e=this.weakmap,r=this.keys,n=0;n<r.length;n++){var t=r[n];if(Object(o.isWindow)(t)&&Object(o.isWindowClosed)(t)){if(e)try{e.delete(t)}catch(e){}r.splice(n,1),this.values.splice(n,1),n-=1}}},e.prototype.isSafeToReadWrite=function(e){if(Object(o.isWindow)(e))return!1;try{e&&e.self,e&&e[this.name]}catch(e){return!1}return!0},e.prototype.set=function(e,r){if(!e)throw new Error("WeakMap expected key");var n=this.weakmap;if(n)try{n.set(e,r)}catch(e){delete this.weakmap}if(this.isSafeToReadWrite(e)){var t=this.name,o=e[t];o&&o[0]===e?o[1]=r:s(e,t,{value:[e,r],writable:!0})}else{this._cleanupClosedWindows();var a=this.keys,c=this.values,u=i(a,e);-1===u?(a.push(e),c.push(r)):c[u]=r}},e.prototype.get=function(e){if(!e)throw new Error("WeakMap expected key");var r=this.weakmap;if(r)try{if(r.has(e))return r.get(e)}catch(e){delete this.weakmap}if(!this.isSafeToReadWrite(e)){this._cleanupClosedWindows();var n=i(this.keys,e);if(-1===n)return;return this.values[n]}var t=e[this.name];if(t&&t[0]===e)return t[1]},e.prototype.delete=function(e){if(!e)throw new Error("WeakMap expected key");var r=this.weakmap;if(r)try{r.delete(e)}catch(e){delete this.weakmap}if(this.isSafeToReadWrite(e)){var n=e[this.name];n&&n[0]===e&&(n[0]=n[1]=void 0)}else{this._cleanupClosedWindows();var t=this.keys,o=i(t,e);-1!==o&&(t.splice(o,1),this.values.splice(o,1))}},e.prototype.has=function(e){if(!e)throw new Error("WeakMap expected key");var r=this.weakmap;if(r)try{return r.has(e)}catch(e){delete this.weakmap}if(this.isSafeToReadWrite(e)){var n=e[this.name];return!(!n||n[0]!==e)}return this._cleanupClosedWindows(),-1!==i(this.keys,e)},e}(),f={POST_MESSAGE_TYPE:{REQUEST:"postrobot_message_request",RESPONSE:"postrobot_message_response",ACK:"postrobot_message_ack"},POST_MESSAGE_ACK:{SUCCESS:"success",ERROR:"error"},POST_MESSAGE_NAMES:{METHOD:"postrobot_method",HELLO:"postrobot_ready",OPEN_TUNNEL:"postrobot_open_tunnel"},WINDOW_TYPES:{FULLPAGE:"fullpage",POPUP:"popup",IFRAME:"iframe"},WINDOW_PROPS:{POSTROBOT:"__postRobot__"},SERIALIZATION_TYPES:{METHOD:"postrobot_method",ERROR:"postrobot_error",PROMISE:"postrobot_promise",ZALGO_PROMISE:"postrobot_zalgo_promise",REGEX:"regex"},SEND_STRATEGIES:{POST_MESSAGE:"postrobot_post_message",BRIDGE:"postrobot_bridge",GLOBAL:"postrobot_global"},MOCK_PROTOCOL:"mock:",FILE_PROTOCOL:"file:",BRIDGE_NAME_PREFIX:"__postrobot_bridge__",POSTROBOT_PROXY:"__postrobot_proxy__",WILDCARD:"*"},d={METHOD:"postrobot_method",HELLO:"postrobot_hello",OPEN_TUNNEL:"postrobot_open_tunnel"},l=(Object.keys(d).map(function(e){return d[e]}),{ALLOW_POSTMESSAGE_POPUP:!("__ALLOW_POSTMESSAGE_POPUP__"in window)||window.__ALLOW_POSTMESSAGE_POPUP__,BRIDGE_TIMEOUT:5e3,CHILD_WINDOW_TIMEOUT:5e3,ACK_TIMEOUT:-1!==window.navigator.userAgent.match(/MSIE/i)?2e3:1e3,RES_TIMEOUT:-1,ALLOWED_POST_MESSAGE_METHODS:(a={},a[f.SEND_STRATEGIES.POST_MESSAGE]=!0,a[f.SEND_STRATEGIES.BRIDGE]=!0,a[f.SEND_STRATEGIES.GLOBAL]=!0,a),ALLOW_SAME_ORIGIN:!1});0===window.location.href.indexOf(f.FILE_PROTOCOL)&&(l.ALLOW_POSTMESSAGE_POPUP=!0);var w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function h(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(r>=3)return"stringifyError stack overflow";try{if(!e)return"<unknown error: "+Object.prototype.toString.call(e)+">";if("string"==typeof e)return e;if(e instanceof Error){var n=e&&e.stack,t=e&&e.message;if(n&&t)return-1!==n.indexOf(t)?n:t+"\n"+n;if(n)return n;if(t)return t}return"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e)}catch(e){return"Error while stringifying error: "+h(e,r+1)}}var p=function(e){if(!e)return e;var r=!1;return function(){if(!r)return r=!0,e.apply(this,arguments)}};function m(){}function _(){var e="0123456789abcdef";return"xxxxxxxxxx".replace(/./g,function(){return e.charAt(Math.floor(Math.random()*e.length))})}function y(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(n>=100)throw new Error("Self-referential object passed, or object contained too many layers");var t=void 0;if("object"!==(void 0===e?"undefined":w(e))||null===e||Array.isArray(e)){if(!Array.isArray(e))throw new TypeError("Invalid type: "+(void 0===e?"undefined":w(e)));t=[]}else t={};return function(e,r){Array.isArray(e)?function(e,r){for(var n=0;n<e.length;n++)r(e[n],n)}(e,r):"object"===(void 0===e?"undefined":w(e))&&null!==e&&function(e,r){for(var n in e)e.hasOwnProperty(n)&&r(e[n],n)}(e,r)}(e,function(e,o){var i=r(e,o);void 0!==i?t[o]=i:"object"===(void 0===e?"undefined":w(e))&&null!==e?t[o]=y(e,r,n+1):t[o]=e}),t}function E(e){return"[object RegExp]"===Object.prototype.toString.call(e)}function O(e){try{if(!e)return!1;if("undefined"!=typeof Promise&&e instanceof Promise)return!0;if("undefined"!=typeof window&&window.Window&&e instanceof window.Window)return!1;if("undefined"!=typeof window&&window.constructor&&e instanceof window.constructor)return!1;var r={}.toString;if(r){var n=r.call(e);if("[object Window]"===n||"[object global]"===n||"[object DOMWindow]"===n)return!1}if("function"==typeof e.then)return!0}catch(e){return!1}return!1}function v(){var e=void 0;if("undefined"!=typeof window)e=window;else{if("undefined"==typeof window)throw new TypeError("Can not find global");e=window}var r=e.__zalgopromise__=e.__zalgopromise__||{};return r.flushPromises=r.flushPromises||[],r.activeCount=r.activeCount||0,r.possiblyUnhandledPromiseHandlers=r.possiblyUnhandledPromiseHandlers||[],r.dispatchedErrors=r.dispatchedErrors||[],r}var S=function(){function e(r){var n=this;if(function(r,n){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.resolved=!1,this.rejected=!1,this.errorHandled=!1,this.handlers=[],r){var t=void 0,o=void 0,i=!1,a=!1,s=!1;try{r(function(e){s?n.resolve(e):(i=!0,t=e)},function(e){s?n.reject(e):(a=!0,o=e)})}catch(e){return void this.reject(e)}s=!0,i?this.resolve(t):a&&this.reject(o)}}return e.prototype.resolve=function(e){if(this.resolved||this.rejected)return this;if(O(e))throw new Error("Can not resolve promise with another promise");return this.resolved=!0,this.value=e,this.dispatch(),this},e.prototype.reject=function(e){var r=this;if(this.resolved||this.rejected)return this;if(O(e))throw new Error("Can not reject promise with another promise");if(!e){var n=e&&"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e);e=new Error("Expected reject to be called with Error, got "+n)}return this.rejected=!0,this.error=e,this.errorHandled||setTimeout(function(){r.errorHandled||function(e,r){if(-1===v().dispatchedErrors.indexOf(e)){v().dispatchedErrors.push(e),setTimeout(function(){throw e},1);for(var n=0;n<v().possiblyUnhandledPromiseHandlers.length;n++)v().possiblyUnhandledPromiseHandlers[n](e,r)}}(e,r)},1),this.dispatch(),this},e.prototype.asyncReject=function(e){this.errorHandled=!0,this.reject(e)},e.prototype.dispatch=function(){var r=this,n=this.dispatching,t=this.resolved,o=this.rejected,i=this.handlers;if(!n&&(t||o)){this.dispatching=!0,v().activeCount+=1;for(var a=function(n){var a=i[n],s=a.onSuccess,c=a.onError,u=a.promise,f=void 0;if(t)try{f=s?s(r.value):r.value}catch(e){return u.reject(e),"continue"}else if(o){if(!c)return u.reject(r.error),"continue";try{f=c(r.error)}catch(e){return u.reject(e),"continue"}}f instanceof e&&(f.resolved||f.rejected)?(f.resolved?u.resolve(f.value):u.reject(f.error),f.errorHandled=!0):O(f)?f instanceof e&&(f.resolved||f.rejected)?f.resolved?u.resolve(f.value):u.reject(f.error):f.then(function(e){u.resolve(e)},function(e){u.reject(e)}):u.resolve(f)},s=0;s<i.length;s++)a(s);i.length=0,this.dispatching=!1,v().activeCount-=1,0===v().activeCount&&e.flushQueue()}},e.prototype.then=function(r,n){if(r&&"function"!=typeof r&&!r.call)throw new Error("Promise.then expected a function for success handler");if(n&&"function"!=typeof n&&!n.call)throw new Error("Promise.then expected a function for error handler");var t=new e;return this.handlers.push({promise:t,onSuccess:r,onError:n}),this.errorHandled=!0,this.dispatch(),t},e.prototype.catch=function(e){return this.then(void 0,e)},e.prototype.finally=function(r){if(r&&"function"!=typeof r&&!r.call)throw new Error("Promise.finally expected a function");return this.then(function(n){return e.try(r).then(function(){return n})},function(n){return e.try(r).then(function(){throw n})})},e.prototype.timeout=function(e,r){var n=this;if(this.resolved||this.rejected)return this;var t=setTimeout(function(){n.resolved||n.rejected||n.reject(r||new Error("Promise timed out after "+e+"ms"))},e);return this.then(function(e){return clearTimeout(t),e})},e.prototype.toPromise=function(){if("undefined"==typeof Promise)throw new TypeError("Could not find Promise");return Promise.resolve(this)},e.resolve=function(r){return r instanceof e?r:O(r)?new e(function(e,n){return r.then(e,n)}):(new e).resolve(r)},e.reject=function(r){return(new e).reject(r)},e.all=function(r){var n=new e,t=r.length,o=[];if(!t)return n.resolve(o),n;for(var i=function(i){var a=r[i];if(a instanceof e){if(a.resolved)return o[i]=a.value,t-=1,"continue"}else if(!O(a))return o[i]=a,t-=1,"continue";e.resolve(a).then(function(e){o[i]=e,0==(t-=1)&&n.resolve(o)},function(e){n.reject(e)})},a=0;a<r.length;a++)i(a);return 0===t&&n.resolve(o),n},e.hash=function(r){var n={};return e.all(Object.keys(r).map(function(t){return e.resolve(r[t]).then(function(e){n[t]=e})})).then(function(){return n})},e.map=function(r,n){return e.all(r.map(n))},e.onPossiblyUnhandledException=function(e){return function(e){return v().possiblyUnhandledPromiseHandlers.push(e),{cancel:function(){v().possiblyUnhandledPromiseHandlers.splice(v().possiblyUnhandledPromiseHandlers.indexOf(e),1)}}}(e)},e.try=function(r,n,t){if(r&&"function"!=typeof r&&!r.call)throw new Error("Promise.try expected a function");var o=void 0;try{o=r.apply(n,t||[])}catch(r){return e.reject(r)}return e.resolve(o)},e.delay=function(r){return new e(function(e){setTimeout(e,r)})},e.isPromise=function(r){return!!(r&&r instanceof e)||O(r)},e.flush=function(){var r=new e;return v().flushPromises.push(r),0===v().activeCount&&e.flushQueue(),r},e.flushQueue=function(){var e=v().flushPromises;v().flushPromises=[];for(var r=0,n=null==e?0:e.length;r<n;r++)e[r].resolve()},e}(),g=window[f.WINDOW_PROPS.POSTROBOT]=window[f.WINDOW_PROPS.POSTROBOT]||{};g.registerSelf=function(){};var P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};g.methods=g.methods||new u;var A=p(function(){g.on(f.POST_MESSAGE_NAMES.METHOD,{origin:f.WILDCARD},function(e){var r=e.source,n=e.origin,t=e.data,i=g.methods.get(r);if(!i)throw new Error("Could not find any methods this window has privileges to call");var a=i[t.id];if(!a)throw new Error("Could not find method with id: "+t.id);if(!Object(o.matchDomain)(a.domain,n))throw new Error("Method domain "+a.domain+" does not match origin "+n);return S.try(function(){return a.method.apply({source:r,origin:n,data:t},t.args)}).then(function(e){return{result:e,id:t.id,name:t.name}})})});function b(e,r){return"object"===(void 0===e?"undefined":P(e))&&null!==e&&e.__type__===r}function T(e,r,n,t){var o=_(),i=g.methods.get(e);return i||(i={},g.methods.set(e,i)),i[o]={domain:r,method:n},{__type__:f.SERIALIZATION_TYPES.METHOD,__id__:o,__name__:t}}function R(e,r,n){function t(){var t=Array.prototype.slice.call(arguments);return g.send(e,f.POST_MESSAGE_NAMES.METHOD,{id:n.__id__,name:n.__name__,args:t},{domain:r,timeout:-1}).then(function(e){return e.data.result},function(e){throw e})}return t.__name__=n.__name__,t.__xdomain__=!0,t.source=e,t.origin=r,t}function I(e,r,n){return new S(function(t,o){return R(e,r,n.__then__)(t,o)})}function W(e){return g.send(e,f.POST_MESSAGE_NAMES.HELLO,{},{domain:f.WILDCARD,timeout:-1}).then(function(e){return{origin:e.origin}})}g.readyPromises=g.readyPromises||new u;var D={};D[f.SEND_STRATEGIES.POST_MESSAGE]=function(e,r,n){(Array.isArray(n)?n:"string"==typeof n?[n]:[f.WILDCARD]).map(function(r){if(0===r.indexOf(f.MOCK_PROTOCOL)){if(window.location.protocol===f.FILE_PROTOCOL)return f.WILDCARD;if(!Object(o.isActuallySameDomain)(e))throw new Error("Attempting to send messsage to mock domain "+r+", but window is actually cross-domain");return Object(o.getActualDomain)(e)}return 0===r.indexOf(f.FILE_PROTOCOL)?f.WILDCARD:r}).forEach(function(n){return e.postMessage(r,n)})};var L=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e};function j(e,r,n){return S.try(function(){var t;if(r=function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t=_(),i=Object(o.isPopup)()?f.WINDOW_TYPES.POPUP:Object(o.isIframe)()?f.WINDOW_TYPES.IFRAME:f.WINDOW_TYPES.FULLPAGE,a=Object(o.getDomain)(window);return L({},r,n,{sourceDomain:a,id:r.id||t,windowType:i})}(e,r,{data:function(e,n,t){return y({obj:r.data},function(r,t){return"function"==typeof r?T(e,n,r,t.toString()):r instanceof Error?(o=r,{__type__:f.SERIALIZATION_TYPES.ERROR,__message__:h(o),__code__:o.code}):window.Promise&&r instanceof window.Promise?function(e,r,n,t){return{__type__:f.SERIALIZATION_TYPES.PROMISE,__then__:T(e,r,function(e,r){return n.then(e,r)},t+".then")}}(e,n,r,t.toString()):S.isPromise(r)?function(e,r,n,t){return{__type__:f.SERIALIZATION_TYPES.ZALGO_PROMISE,__then__:T(e,r,function(e,r){return n.then(e,r)},t+".then")}}(e,n,r,t.toString()):E(r)?(i=r,{__type__:f.SERIALIZATION_TYPES.REGEX,__source__:i.source}):void 0;var o,i}).obj}(e,n),domain:n}),e===window&&!l.ALLOW_SAME_ORIGIN)throw new Error("Attemping to send message to self");if(Object(o.isWindowClosed)(e))throw new Error("Window is closed");var i=[],a=function(e,r,n){var t=void 0,o=void 0;try{if("{}"!==JSON.stringify({})&&(t=Object.prototype.toJSON,delete Object.prototype.toJSON),"{}"!==JSON.stringify({}))throw new Error("Can not correctly serialize JSON objects");if("[]"!==JSON.stringify([])&&(o=Array.prototype.toJSON,delete Array.prototype.toJSON),"[]"!==JSON.stringify([]))throw new Error("Can not correctly serialize JSON objects")}catch(e){throw new Error("Can not repair JSON.stringify: "+e.message)}var i=JSON.stringify.call(this,e,null,2);try{t&&(Object.prototype.toJSON=t),o&&(Array.prototype.toJSON=o)}catch(e){throw new Error("Can not repair JSON.stringify: "+e.message)}return i}(((t={})[f.WINDOW_PROPS.POSTROBOT]=r,t));return S.map(Object.keys(D),function(r){return S.try(function(){if(!l.ALLOWED_POST_MESSAGE_METHODS[r])throw new Error("Strategy disallowed: "+r);return D[r](e,a,n)}).then(function(){return i.push(r+": success"),!0},function(e){return i.push(r+": "+h(e)+"\n"),!1})}).then(function(e){var n=e.some(Boolean),t=r.type+" "+r.name+" "+(n?"success":"error")+":\n  - "+i.join("\n  - ")+"\n";if(!n)throw new Error(t)})})}g.responseListeners=g.responseListeners||{},g.requestListeners=g.requestListeners||{},g.WINDOW_WILDCARD=g.WINDOW_WILDCARD||new function(){},g.erroredResponseListeners=g.erroredResponseListeners||{};var C,M="__domain_regex__";function N(e){return g.responseListeners[e]}function x(e){delete g.responseListeners[e]}function k(e){return Boolean(g.erroredResponseListeners[e])}function G(e){var r=e.name,n=e.win,t=e.domain;if(n===f.WILDCARD&&(n=null),t===f.WILDCARD&&(t=null),!r)throw new Error("Name required to get request listener");var i=g.requestListeners[r];if(i)for(var a=0,s=[n,g.WINDOW_WILDCARD],c=null==s?0:s.length;a<c;a++){var u=s[a],d=u&&i.get(u);if(d){if(t&&"string"==typeof t){if(d[t])return d[t];if(d[M])for(var l=0,w=d[M],h=null==w?0:w.length;l<h;l++){var p=w[l],m=p.regex,_=p.listener;if(Object(o.matchDomain)(m,t))return _}}if(d[f.WILDCARD])return d[f.WILDCARD]}}}var U=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},H=((C={})[f.POST_MESSAGE_TYPE.ACK]=function(e,r,n){if(!k(n.hash)){var t=N(n.hash);if(!t)throw new Error("No handler found for post message ack for message: "+n.name+" from "+r+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!Object(o.matchDomain)(t.domain,r))throw new Error("Ack origin "+r+" does not match domain "+t.domain.toString());t.ack=!0}},C[f.POST_MESSAGE_TYPE.REQUEST]=function(e,r,n){var t=G({name:n.name,win:e,domain:r});function i(t){return n.fireAndForget||Object(o.isWindowClosed)(e)?S.resolve():j(e,U({target:n.originalSource,hash:n.hash,name:n.name},t),r)}return S.all([i({type:f.POST_MESSAGE_TYPE.ACK}),S.try(function(){if(!t)throw new Error("No handler found for post message: "+n.name+" from "+r+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!Object(o.matchDomain)(t.domain,r))throw new Error("Request origin "+r+" does not match domain "+t.domain.toString());var i=n.data;return t.handler({source:e,origin:r,data:i})}).then(function(e){return i({type:f.POST_MESSAGE_TYPE.RESPONSE,ack:f.POST_MESSAGE_ACK.SUCCESS,data:e})},function(e){var r=h(e).replace(/^Error: /,""),n=e.code;return i({type:f.POST_MESSAGE_TYPE.RESPONSE,ack:f.POST_MESSAGE_ACK.ERROR,error:r,code:n})})]).then(m).catch(function(e){if(t&&t.handleError)return t.handleError(e);throw e})},C[f.POST_MESSAGE_TYPE.RESPONSE]=function(e,r,n){if(!k(n.hash)){var t=N(n.hash);if(!t)throw new Error("No handler found for post message response for message: "+n.name+" from "+r+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!Object(o.matchDomain)(t.domain,r))throw new Error("Response origin "+r+" does not match domain "+Object(o.stringifyDomainPattern)(t.domain));if(x(n.hash),n.ack===f.POST_MESSAGE_ACK.ERROR){var i=new Error(n.error);return n.code&&(i.code=n.code),t.respond(i,null)}if(n.ack===f.POST_MESSAGE_ACK.SUCCESS){var a=n.data||n.response;return t.respond(null,{source:e,origin:r,data:a})}}},C),B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function Y(e){if(!window||window.closed)throw new Error("Message recieved in closed window");try{if(!e.source)return}catch(e){return}var r=e.source,n=e.origin,t=function(e){var r,n=void 0;try{r=e,n=JSON.parse(r)}catch(e){return}if(n&&"object"===(void 0===n?"undefined":B(n))&&null!==n&&(n=n[f.WINDOW_PROPS.POSTROBOT])&&"object"===(void 0===n?"undefined":B(n))&&null!==n&&n.type&&"string"==typeof n.type&&H[n.type])return n}(e.data);if(t){if(!t.sourceDomain||"string"!=typeof t.sourceDomain)throw new Error("Expected message to have sourceDomain");0!==t.sourceDomain.indexOf(f.MOCK_PROTOCOL)&&0!==t.sourceDomain.indexOf(f.FILE_PROTOCOL)||(n=t.sourceDomain),-1===g.receivedMessages.indexOf(t.id)&&(g.receivedMessages.push(t.id),Object(o.isWindowClosed)(r)&&!t.fireAndForget||(t.data&&(t.data=function(e,r,n){return y({obj:t.data},function(n){var t,o;if("object"===(void 0===n?"undefined":P(n))&&null!==n)return b(n,f.SERIALIZATION_TYPES.METHOD)?R(e,r,n):b(n,f.SERIALIZATION_TYPES.ERROR)?(t=n,o=new Error(t.__message__),t.__code__&&(o.code=t.__code__),o):b(n,f.SERIALIZATION_TYPES.PROMISE)?function(e,r,n){return window.Promise?new window.Promise(function(t,o){return R(e,r,n.__then__)(t,o)}):I(e,r,n)}(e,r,n):b(n,f.SERIALIZATION_TYPES.ZALGO_PROMISE)?I(e,r,n):b(n,f.SERIALIZATION_TYPES.REGEX)?function(e,r,n){return new RegExp(n.__source__)}(0,0,n):void 0}).obj}(r,n)),H[t.type](r,n,t)))}}function q(e){try{e.source}catch(e){return}Y({source:e.source||e.sourceElement,origin:e.origin||e.originalEvent&&e.originalEvent.origin,data:e.data})}function F(e){return S.try(function(){if(!e.name)throw new Error("Expected options.name");var r=e.name,n=void 0,t=void 0;if("string"==typeof e.window){var i=document.getElementById(e.window);if(!i)throw new Error("Expected options.window "+Object.prototype.toString.call(e.window)+" to be a valid element id");if("iframe"!==i.tagName.toLowerCase())throw new Error("Expected options.window "+Object.prototype.toString.call(e.window)+" to be an iframe");if(!i.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");n=i.contentWindow}else if(e.window instanceof HTMLIFrameElement){if("iframe"!==e.window.tagName.toLowerCase())throw new Error("Expected options.window "+Object.prototype.toString.call(e.window)+" to be an iframe");if(e.window&&!e.window.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");e.window&&e.window.contentWindow&&(n=e.window.contentWindow)}else n=e.window;if(!n)throw new Error("Expected options.window to be a window object, iframe, or iframe element id.");var a=n;t=e.domain||f.WILDCARD;var s=e.name+"_"+_();if(Object(o.isWindowClosed)(a))throw new Error("Target window is closed");var c=!1,u=g.requestPromises.get(a);u||(u=[],g.requestPromises.set(a,u));var d=S.try(function(){if(Object(o.isAncestor)(window,a))return function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Window",t=g.readyPromises.get(e);return t||(t=new S,g.readyPromises.set(e,t),-1!==r&&setTimeout(function(){return t.reject(new Error(n+" did not load after "+r+"ms"))},r),t)}(a,e.timeout||l.CHILD_WINDOW_TIMEOUT)}).then(function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).origin;if(E(t)&&!e)return W(a)}).then(function(){var n=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).origin;if(E(t)){if(!Object(o.matchDomain)(t,n))throw new Error("Remote window domain "+n+" does not match regex: "+t.toString());t=n}if("string"!=typeof t&&!Array.isArray(t))throw new TypeError("Expected domain to be a string or array");var i=t;return new S(function(n,t){var w=void 0;if(e.fireAndForget||function(e,r){g.responseListeners[e]=r}(s,w={name:r,window:a,domain:i,respond:function(e,r){e||(c=!0,u.splice(u.indexOf(d,1))),e?t(e):n(r)}}),j(a,{type:f.POST_MESSAGE_TYPE.REQUEST,hash:s,name:r,data:e.data,fireAndForget:e.fireAndForget},i).catch(t),e.fireAndForget)return n();var h=l.ACK_TIMEOUT,p=e.timeout||l.RES_TIMEOUT,m=100;setTimeout(function n(){if(!c){if(Object(o.isWindowClosed)(a))return w.ack?t(new Error("Window closed for "+r+" before response")):t(new Error("Window closed for "+r+" before ack"));if(h=Math.max(h-m,0),-1!==p&&(p=Math.max(p-m,0)),w.ack){if(-1===p)return;m=Math.min(p,2e3)}else{if(0===h)return t(new Error("No ack for postMessage "+r+" in "+Object(o.getDomain)()+" in "+l.ACK_TIMEOUT+"ms"));if(0===p)return t(new Error("No response for postMessage "+r+" in "+Object(o.getDomain)()+" in "+(e.timeout||l.RES_TIMEOUT)+"ms"))}setTimeout(n,m)}},m)})});return d.catch(function(){!function(e){g.erroredResponseListeners[e]=!0}(s),x(s)}),u.push(d),d})}function J(e,r,n,t){return(t=t||{}).window=e,t.name=r,t.data=n,F(t)}function K(e,r,n){var t=Object(o.getAncestor)();return t?J(t,e,r,n):new S(function(e,r){return r(new Error("Window does not have a parent"))})}function Z(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e.window)throw new Error("Expected options.window");var r=e.window;return{send:function(n,t){return J(r,n,t,e)}}}g.receivedMessages=g.receivedMessages||[],g.receiveMessage=Y,g.requestPromises=g.requestPromises||new u,g.send=J;var z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function Q(e){if(!e.name)throw new Error("Expected options.name");if(!e.handler)throw new Error("Expected options.handler");var r,n,t,i=e.name,a=e.window,s=e.domain,c={handler:e.handler,handleError:e.errorHandler||function(e){throw e},window:a,domain:s||f.WILDCARD,name:i},d=function e(r,n){var t=r.name,o=r.win,i=r.domain;if(!t||"string"!=typeof t)throw new Error("Name required to add request listener");if(Array.isArray(o)){for(var a=[],s=0,c=o,d=null==c?0:c.length;s<d;s++){var l=c[s];a.push(e({name:t,domain:i,win:l},n))}return{cancel:function(){for(var e=0,r=null==a?0:a.length;e<r;e++)a[e].cancel()}}}if(Array.isArray(i)){for(var w=[],h=0,p=i,m=null==p?0:p.length;h<m;h++){var _=p[h];w.push(e({name:t,win:o,domain:_},n))}return{cancel:function(){for(var e=0,r=null==w?0:w.length;e<r;e++)w[e].cancel()}}}var y=G({name:t,win:o,domain:i});if(o&&o!==f.WILDCARD||(o=g.WINDOW_WILDCARD),i=i||f.WILDCARD,y)throw o&&i?new Error("Request listener already exists for "+t+" on domain "+i.toString()+" for "+(o===g.WINDOW_WILDCARD?"wildcard":"specified")+" window"):o?new Error("Request listener already exists for "+t+" for "+(o===g.WINDOW_WILDCARD?"wildcard":"specified")+" window"):i?new Error("Request listener already exists for "+t+" on domain "+i.toString()):new Error("Request listener already exists for "+t);var O=g.requestListeners,v=O[t];v||(v=new u,O[t]=v);var S=v.get(o);S||(S={},v.set(o,S));var P=i.toString(),A=S[M],b=void 0;return E(i)?(A||(A=[],S[M]=A),b={regex:i,listener:n},A.push(b)):S[P]=n,{cancel:function(){S&&(delete S[P],o&&0===Object.keys(S).length&&v.delete(o),b&&A.splice(A.indexOf(b,1)))}}}({name:i,win:a,domain:s},c);if(e.once){var l=c.handler;c.handler=p(function(){return d.cancel(),l.apply(this,arguments)})}if(c.window&&e.errorOnClose)var w=(r=function(){a&&"object"===(void 0===a?"undefined":z(a))&&Object(o.isWindowClosed)(a)&&(w.cancel(),c.handleError(new Error("Post message target window is closed")))},n=50,t=void 0,t=setTimeout(function e(){t=setTimeout(e,n),r.call()},n),{cancel:function(){clearTimeout(t)}});return{cancel:function(){d.cancel()}}}function X(e,r,n){return"function"==typeof r&&(n=r,r={}),(r=r||{}).name=e,r.handler=n||r.handler,Q(r)}function V(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];"function"==typeof r&&(n=r,r={}),r=r||{},n=n||r.handler;var t=r.errorHandler,o=new S(function(o,i){(r=r||{}).name=e,r.once=!0,r.handler=function(e){if(o(e),n)return n(e)},r.errorHandler=function(e){if(i(e),t)return t(e)}}),i=Q(r);return o.cancel=i.cancel,o}function $(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{on:function(r,n){return X(r,e,n)}}}function ee(){delete window[f.WINDOW_PROPS.POSTROBOT],window.removeEventListener("message",q)}g.on=X;var re=Object(o.getAncestor)();function ne(e){var r=g.requestPromises.get(e);if(r)for(var n=0,t=null==r?0:r.length;n<t;n++)r[n].reject(new Error("No response from window - cleaned up"));g.popupWindowsByWin&&g.popupWindowsByWin.delete(e),g.remoteWindows&&g.remoteWindows.delete(e),g.requestPromises.delete(e),g.methods.delete(e),g.readyPromises.delete(e)}var te=null;function oe(){var e,r,n;g.initialized||(r="message",n=q,(e=window).addEventListener?e.addEventListener(r,n):e.attachEvent("on"+r,n),function(){var e;e=function(e){var r=e.source,n=e.origin,t=g.readyPromises.get(r)||new S;t.resolve({origin:n}),g.readyPromises.set(r,t)},g.on(f.POST_MESSAGE_NAMES.HELLO,{domain:f.WILDCARD},function(r){var n=r.source,t=r.origin;return e({source:n,origin:t})});var r=Object(o.getAncestor)();r&&W(r).catch(m)}(),A({on:X,send:J})),g.initialized=!0}oe(),n.d(r,"cleanUpWindow",function(){return ne}),n.d(r,"Promise",function(){return S}),n.d(r,"bridge",function(){return te}),n.d(r,"init",function(){return oe}),n.d(r,"parent",function(){return re}),n.d(r,"send",function(){return J}),n.d(r,"request",function(){return F}),n.d(r,"sendToParent",function(){return K}),n.d(r,"client",function(){return Z}),n.d(r,"on",function(){return X}),n.d(r,"listen",function(){return Q}),n.d(r,"once",function(){return V}),n.d(r,"listener",function(){return $}),n.d(r,"CONFIG",function(){return l}),n.d(r,"CONSTANTS",function(){return f}),n.d(r,"disable",function(){return ee}),r.default=t},function(e,r,n){"use strict";function t(e){return"[object RegExp]"===Object.prototype.toString.call(e)}r.a=f,r.c=d,r.e=l,r.j=function(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{if(e===window)return!1}catch(e){return!0}try{if(!e)return!0}catch(e){return!0}try{if(e.closed)return!0}catch(e){return!e||e.message!==i}if(r&&function(e){if(!l(e))return!1;try{if(e===window)return!0;if(a(e)&&u(e))return!0;if(d(window)===d(e))return!0}catch(e){}return!1}(e))try{if(e.mockclosed)return!0}catch(e){}try{if(!e.parent||!e.top)return!0}catch(e){}var n=function(e,r){for(var n=0;n<e.length;n++)try{if(e[n]===r)return n}catch(e){}return-1}(p,e);if(-1!==n){var t=m[n];if(t&&function(e){if(!e.contentWindow)return!0;if(!e.parentNode)return!0;var r=e.ownerDocument;return!(!r||!r.body||r.body.contains(e))}(t))return!0}return!1},r.d=function(e){return(e=e||window).navigator.mockUserAgent||e.navigator.userAgent},r.b=_,r.f=function(e,r){var n=_(r);if(n)return n===e;if(r===e)return!1;if(function(e){if(e){try{if(e.top)return e.top}catch(e){}if(s(e)===e)return e;try{if(w(window,e)&&window.top)return window.top}catch(e){}try{if(w(e,window)&&window.top)return window.top}catch(e){}for(var r=0,n=function e(r){for(var n=[],t=0,o=h(r),i=null==o?0:o.length;t<i;t++){var a=o[t];n.push(a);for(var s=0,c=e(a),u=null==c?0:c.length;s<u;s++){var f=c[s];n.push(f)}}return n}(e),t=null==n?0:n.length;r<t;r++){var o=n[r];try{if(o.top)return o.top}catch(e){}if(s(o)===o)return o}}}(r)===r)return!1;for(var t=0,o=h(e),i=null==o?0:o.length;t<i;t++)if(o[t]===r)return!0;return!1},r.h=function(){return Boolean(c(window))},r.g=function(){return Boolean(s(window))},r.k=function e(r,n){if("string"==typeof r){if("string"==typeof n)return r===o.WILDCARD||n===r;if(t(n))return!1;if(Array.isArray(n))return!1}return t(r)?t(n)?r.toString()===n.toString():!Array.isArray(n)&&Boolean(n.match(r)):!!Array.isArray(r)&&(Array.isArray(n)?JSON.stringify(r)===JSON.stringify(n):!t(n)&&r.some(function(r){return e(r,n)}))},r.l=function(e){return Array.isArray(e)?"("+e.join(" | ")+")":t(e)?"RegExp("+e.toString():e.toString()},r.i=function(e){try{if(e===window)return!0}catch(e){if(e&&e.message===i)return!0}try{if("[object Window]"===Object.prototype.toString.call(e))return!0}catch(e){if(e&&e.message===i)return!0}try{if(window.Window&&e instanceof window.Window)return!0}catch(e){if(e&&e.message===i)return!0}try{if(e&&e.self===e)return!0}catch(e){if(e&&e.message===i)return!0}try{if(e&&e.parent===e)return!0}catch(e){if(e&&e.message===i)return!0}try{if(e&&e.top===e)return!0}catch(e){if(e&&e.message===i)return!0}try{e&&e.__cross_domain_utils_window_check__}catch(e){return!0}return!1};var o={MOCK_PROTOCOL:"mock:",FILE_PROTOCOL:"file:",ABOUT_PROTOCOL:"about:",WILDCARD:"*"},i="Call was rejected by callee.\r\n";function a(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:window).location.protocol===o.ABOUT_PROTOCOL}function s(e){if(e)try{if(e.parent&&e.parent!==e)return e.parent}catch(e){}}function c(e){if(e&&!s(e))try{return e.opener}catch(e){}}function u(e){try{return e&&e.location&&e.location.href,!0}catch(e){}return!1}function f(e){var r=(e=e||window).location;if(!r)throw new Error("Can not read window location");var n=r.protocol;if(!n)throw new Error("Can not read window protocol");if(n===o.FILE_PROTOCOL)return o.FILE_PROTOCOL+"//";if(n===o.ABOUT_PROTOCOL){var t=s(e);return t&&u(t)?f(t):o.ABOUT_PROTOCOL+"//"}var i=r.host;if(!i)throw new Error("Can not read window host");return n+"//"+i}function d(e){var r=f(e=e||window);return r&&e.mockDomain&&0===e.mockDomain.indexOf(o.MOCK_PROTOCOL)?e.mockDomain:r}function l(e){try{if(e===window)return!0}catch(e){}try{var r=Object.getOwnPropertyDescriptor(e,"location");if(r&&!1===r.enumerable)return!1}catch(e){}try{if(a(e)&&u(e))return!0}catch(e){}try{if(f(e)===f(window))return!0}catch(e){}return!1}function w(e,r){if(!e||!r)return!1;var n=s(r);return n?n===e:-1!==function(e){var r=[];try{for(;e.parent!==e;)r.push(e.parent),e=e.parent}catch(e){}return r}(r).indexOf(e)}function h(e){var r=[],n=void 0;try{n=e.frames}catch(r){n=e}var t=void 0;try{t=n.length}catch(e){}if(0===t)return r;if(t){for(var o=0;o<t;o++){var i=void 0;try{i=n[o]}catch(e){continue}r.push(i)}return r}for(var a=0;a<100;a++){var s=void 0;try{s=n[a]}catch(e){return r}if(!s)return r;r.push(s)}return r}var p=[],m=[];function _(e){return c(e=e||window)||s(e)||void 0}},function(e,r){}])});
//# sourceMappingURL=post-robot.min.js.map
//# sourceMappingURL=post-robot.min.js.map